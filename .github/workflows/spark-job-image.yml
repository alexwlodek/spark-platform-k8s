name: Spark Job Image

on:
  push:
    branches:
      - main
    paths:
      - apps/spark-job/**
      - .github/workflows/spark-job-image.yml
  workflow_dispatch:

permissions:
  contents: read

concurrency:
  group: spark-job-image
  cancel-in-progress: false

jobs:
  build-and-push:
    name: Build And Push Image
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    outputs:
      image_repository: ${{ steps.meta.outputs.image_repository }}
      image_tag: ${{ steps.meta.outputs.image_tag }}
    env:
      GHCR_IMAGE_REPOSITORY: ${{ vars.GHCR_IMAGE_REPOSITORY }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Compute image metadata
        id: meta
        run: |
          OWNER_LC="$(echo "${GITHUB_REPOSITORY_OWNER}" | tr '[:upper:]' '[:lower:]')"
          IMAGE_PATH="${GHCR_IMAGE_REPOSITORY:-${OWNER_LC}/spark-demo-job}"
          IMAGE_PATH="${IMAGE_PATH#ghcr.io/}"
          IMAGE_REPOSITORY="ghcr.io/${IMAGE_PATH}"
          IMAGE_TAG="sha-${GITHUB_SHA::12}"
          echo "image_repository=${IMAGE_REPOSITORY}" >> "${GITHUB_OUTPUT}"
          echo "image_tag=${IMAGE_TAG}" >> "${GITHUB_OUTPUT}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: apps/spark-job
          file: apps/spark-job/Dockerfile
          push: true
          tags: |
            ${{ steps.meta.outputs.image_repository }}:${{ steps.meta.outputs.image_tag }}
            ${{ steps.meta.outputs.image_repository }}:main
          provenance: false

  gitops-pr:
    name: Create GitOps PR
    runs-on: ubuntu-latest
    needs:
      - build-and-push
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update image in values/dev/demo-apps.yaml
        run: |
          sed -i -E "s|^([[:space:]]*repository:).*$|\\1 ${{ needs.build-and-push.outputs.image_repository }}|" values/dev/demo-apps.yaml
          sed -i -E "s|^([[:space:]]*tag:).*$|\\1 \"${{ needs.build-and-push.outputs.image_tag }}\"|" values/dev/demo-apps.yaml

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          base: main
          branch: ci/spark-job-image-${{ needs.build-and-push.outputs.image_tag }}
          delete-branch: true
          add-paths: |
            values/dev/demo-apps.yaml
          commit-message: "chore(demo-apps): bump spark job image to ${{ needs.build-and-push.outputs.image_tag }}"
          title: "chore(demo-apps): bump spark job image to ${{ needs.build-and-push.outputs.image_tag }}"
          body: |
            Automated GitOps update after Spark job image build.

            - image repository: `${{ needs.build-and-push.outputs.image_repository }}`
            - image tag: `${{ needs.build-and-push.outputs.image_tag }}`
